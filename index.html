<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FanDuel Player Props Viewer</title>

<style>
:root{
  --bg:#0b0f14; --panel:#111826; --text:#e7edf5; --muted:#a9b9cd;
  --border:#223044; --novig:#7d5cff; --hover:#162235;
}
body{ margin:0; background:var(--bg); color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
header{ padding:16px 18px; border-bottom:1px solid var(--border); }
h1{ margin:0 0 6px; font-size:20px; }
.sub{ color:var(--muted); font-size:14px; }

.wrap{ padding:14px 18px 28px; }

.controls{
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:12px;
  display:grid; gap:10px;
}
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

.field{
  display:flex; align-items:center; gap:8px;
  border:1px solid var(--border);
  border-radius:999px; padding:10px 12px;
  flex:1 1 240px;
}
.field label{ font-size:13px; color:var(--muted); }
.field input, .field select{
  background:transparent; border:0; color:var(--text);
  width:100%; outline:none;
}

button{
  background:rgba(255,255,255,.04);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:10px;
  padding:10px 12px;
  cursor:pointer;
}

.meta{
  margin-top:12px; font-size:14px; color:var(--muted);
  display:flex; gap:14px; flex-wrap:wrap;
}

.table-wrap{
  margin-top:14px;
  border:1px solid var(--border);
  border-radius:14px;
  background:var(--panel);
  overflow:hidden;
}
table{ width:100%; border-collapse:collapse; table-layout:fixed; }
thead th{
  position:sticky; top:0;
  background:#111826; color:var(--muted);
  padding:12px; cursor:pointer;
}
tbody td{
  padding:12px;
  border-top:1px solid rgba(34,48,68,.5);
}
tbody tr:hover td{ background:var(--hover); }

.novig{
  background:linear-gradient(90deg, rgba(125,92,255,.25), rgba(125,92,255,.05));
  border-left:3px solid var(--novig);
}

/* mobile cards */
.cards{ display:none; margin-top:14px; }
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.card-top{
  display:flex; justify-content:space-between; gap:10px;
}
.card-title{ font-weight:700; font-size:16px; }
.chip{
  border:1px solid var(--border);
  border-radius:999px;
  padding:4px 8px;
  font-size:12px; color:var(--muted);
}
.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px; margin-top:10px;
}
.k{ font-size:12px; color:var(--muted); }
.v{ font-size:15px; }
.v.novigv{
  background:linear-gradient(90deg, rgba(125,92,255,.3), rgba(125,92,255,.1));
  padding:8px; border-radius:10px;
  text-align:center; font-weight:700;
}

@media (max-width:720px){
  .table-wrap{ display:none; }
  .cards{ display:block; }
}
</style>
</head>

<body>
<header>
  <h1>FanDuel Player Props Viewer</h1>
  <div class="sub">Auto-loads latest CSV • No-vig highlighted • Mobile-friendly</div>
</header>

<div class="wrap">
  <div class="controls">
    <div class="row">
      <div class="field">
        <label>Search</label>
        <input id="q" placeholder="Player, market, team…" />
      </div>
      <div class="field" style="flex:0 0 120px">
        <label>Rows</label>
        <select id="rows">
          <option>25</option><option selected>50</option>
          <option>100</option><option value="100000">All</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button id="download">Download filtered CSV</button>
      <button id="clear">Clear filters</button>
    </div>
  </div>

  <div class="meta">
    <div>Source: <strong>cleaned_props.csv</strong></div>
    <div>Rows: <strong id="total">0</strong></div>
    <div>Showing: <strong id="shown">0</strong></div>
  </div>

  <div class="table-wrap">
    <table>
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="cards" id="cards"></div>
</div>

<script>
const CSV_URL = "cleaned_props.csv?ts=" + Date.now();

/* columns */
const DISPLAY = [
  { key:"commence_time", label:"Game Time" },
  { key:"market", label:"Market" },
  { key:"description", label:"Player" },
  { key:"point", label:"Line" },
  { key:"outcome", label:"Outcome" },
  { key:"price_american", label:"FanDuel Prop" },
  { key:"no_vig_prob", label:"No Vig %", novig:true },
  { key:"home_team", label:"Home Team" },
  { key:"away_team", label:"Away Team" },
];

/* robust CSV parser */
function parseCSV(text){
  const rows=[], row=[]; let cur="", q=false;
  for(let i=0;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(q){
      if(c=='"' && n=='"'){cur+='"';i++;}
      else if(c=='"'){q=false;}
      else cur+=c;
    }else{
      if(c=='"') q=true;
      else if(c==','){row.push(cur);cur="";}
      else if(c=='\n'){row.push(cur);rows.push(row.splice(0));cur="";}
      else if(c!='\r') cur+=c;
    }
  }
  row.push(cur); rows.push(row);
  return rows;
}

function formatTime(iso){
  if(!iso) return "";
  const d=new Date(iso);
  return d.toLocaleTimeString([], { hour:"numeric", minute:"2-digit" });
}

function format(key,val){
  if(key==="market") return val.replaceAll("_"," ").replace(/\b\w/g,c=>c.toUpperCase());
  if(key==="no_vig_prob") return (Number(val)*100).toFixed(2)+"%";
  if(key==="price_american"){ const n=Number(val); return n>0?`+${n}`:`${n}`; }
  if(key==="commence_time") return formatTime(val);
  return val ?? "";
}

fetch(CSV_URL).then(r=>r.text()).then(text=>{
  const rows=parseCSV(text);
  const headers=rows.shift();
  const data=rows.map(r=>{
    const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o;
  });

  const thead=document.querySelector("thead");
  const tbody=document.querySelector("tbody");
  const cards=document.getElementById("cards");

  thead.innerHTML="<tr>"+DISPLAY.map(c=>`<th>${c.label}</th>`).join("")+"</tr>";

  function render(){
    const q=document.getElementById("q").value.toLowerCase();
    const limit=Number(document.getElementById("rows").value);

    const filtered=data.filter(r=>Object.values(r).join(" ").toLowerCase().includes(q))
      .slice(0,limit);

    tbody.innerHTML="";
    cards.innerHTML="";

    filtered.forEach(r=>{
      const tr=document.createElement("tr");
      DISPLAY.forEach(c=>{
        const td=document.createElement("td");
        td.textContent=format(c.key,r[c.key]);
        if(c.novig) td.classList.add("novig");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);

      cards.innerHTML+=`
        <div class="card">
          <div class="card-top">
            <div class="card-title">${r.description}</div>
            <div class="chip">${format("market",r.market)}</div>
          </div>
          <div class="grid">
            <div><div class="k">Game Time</div><div class="v">${format("commence_time",r.commence_time)}</div></div>
            <div><div class="k">Line</div><div class="v">${r.point}</div></div>
            <div><div class="k">Outcome</div><div class="v">${r.outcome}</div></div>
            <div><div class="k">FanDuel</div><div class="v">${format("price_american",r.price_american)}</div></div>
            <div><div class="k">No Vig</div><div class="v novigv">${format("no_vig_prob",r.no_vig_prob)}</div></div>
            <div><div class="k">Matchup</div><div class="v">${r.away_team} @ ${r.home_team}</div></div>
          </div>
        </div>`;
    });

    document.getElementById("total").textContent=data.length;
    document.getElementById("shown").textContent=filtered.length;
  }

  ["q","rows"].forEach(id=>document.getElementById(id).oninput=render);
  document.getElementById("clear").onclick=()=>{document.getElementById("q").value="";render();};

  document.getElementById("download").onclick=()=>{
    const csv=[DISPLAY.map(c=>c.label).join(","),
      ...data.map(r=>DISPLAY.map(c=>format(c.key,r[c.key])).join(","))].join("\n");
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
    a.download="filtered_props.csv"; a.click();
  };

  render();
});
</script>
</body>
</html>
